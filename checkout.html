<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout | Digital Store Lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-52V8NGGJ');</script>
<!-- End Google Tag Manager -->
  
</head>
<body>
  
  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-52V8NGGJ"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
  
<h1>Checkout</h1>
<p>Fill in your email to complete the demo purchase (no real payment).</p>

<form id="checkout-form">
  <input type="email" placeholder="Your email" required>
  <button type="submit">Place Order</button>
</form>

<script>
const products = {
  "focus-planner": {name: "Focus Planner PDF", price: 9},
  "notion-template": {name: "Notion Workspace Template", price: 19},
  "marketing-checklist": {name: "Marketing Checklist PDF", price: 12},
  "pro-bundle": {name: "Pro Bundle", price: 29}
};

// --------------------
// PUSH BEGIN_CHECKOUT
// --------------------
window.dataLayer = window.dataLayer || [];
let cart = JSON.parse(localStorage.getItem('cart')) || [];

if(cart.length > 0){
  const items = cart.map(id => ({
    item_id: id,
    item_name: products[id].name,
    price: products[id].price,
    quantity: 1
  }));
  const total = items.reduce((sum, i) => sum + i.price, 0);

  dataLayer.push({
    event: 'begin_checkout',
    ecommerce: {
      currency: 'USD',
      value: total,
      items: items
    }
  });
}

// --------------------
// HANDLE PURCHASE ON SUBMIT
// --------------------
document.getElementById('checkout-form').addEventListener('submit', function(e) {
  e.preventDefault();

  if(cart.length === 0){
    alert('Cart is empty!');
    return;
  }

  const items = cart.map(id => ({
    item_id: id,
    item_name: products[id].name,
    price: products[id].price,
    quantity: 1
  }));
  const total = items.reduce((sum, i) => sum + i.price, 0);

  // PUSH PURCHASE
  dataLayer.push({
    event: 'purchase',
    ecommerce: {
      transaction_id: 'T_' + Date.now(),
      currency: 'USD',
      value: total,
      items: items
    }
  });

  // Сохраняем заказ для Thank You
  const orderData = {
    transaction_id: 'T_' + Date.now(),
    currency: 'USD',
    value: total,
    items: items
  };
  sessionStorage.setItem('orderData', JSON.stringify(orderData));

  // Очищаем корзину (демо)
  localStorage.removeItem('cart');

  // Перенаправление на Thank You
  window.location.href = 'thankyou.html';
});
</script>

<p><a href="shop.html">Back to Shop</a></p>

<hr>
<footer style="margin-top: 30px; font-size: 0.9em; color: #555;">
  Demo project — non-commercial | <a href="index.html">Home</a>
</footer>

</body>
</html>
